# KIS API 테스트 중심 개발 계획

**목표**: GitHub 샘플코드를 활용하여 LV1 Observer에 KIS API를 안전하고 체계적으로 통합

**전략**: 단계별 테스트 → 검증 → 통합 → 문서화

---

## Phase 1: KIS API 기본 연결 테스트 환경 구축

### 1.1 GitHub 샘플코드 분석 및 이해
- [x] `open-trading-api-main/examples_llm/kis_auth.py` 상세 분석
- [x] 인증 토큰 발급 로직 이해 (`auth()` 함수)
- [x] API 호출 공통 함수 이해 (`_url_fetch()` 함수)
- [x] 환경 설정 구조 이해 (`kis_devlp.yaml` 형식)

### 1.2 테스트 환경 설정
- [x] KIS API 모의투자 계정 신청 확인 (설정 가이드 작성)
- [x] GitHub 호환 설정 시스템 구축 (`get_kis_config()` 메서드)
- [x] 기존 `config/settings.py`에 KIS API 설정 통합
- [x] 테스트용 환경변수 `.env` 업데이트

### 1.3 기본 인증 테스트 스크립트 작성
- [x] `tests/test_kis_auth.py` 생성 - 인증 테스트
- [x] 토큰 발급 기능 테스트 (Mock 토큰 포함)
- [x] 토큰 저장/읽기 기능 테스트
- [x] 연결 상태 확인 기능 테스트

### 1.4 API 호출 기본 인프라 테스트
- [x] 기본 헤더 설정 테스트
- [x] Rate limiting 및 지연 처리 테스트
- [x] 에러 응답 처리 테스트 (Mock)
- [x] 재시도 로직 테스트 (구조 검증)

---

## Phase 2: 핵심 API 기능 개별 테스트

### 2.1 포트폴리오 조회 API 테스트
- [ ] `inquire_balance` API 기본 호출 테스트
- [ ] 모의투자 계정 잔고 데이터 조회 확인
- [ ] API 응답 구조 분석 및 문서화
- [ ] 연속 조회 기능 (페이징) 테스트
- [ ] 에러 케이스 처리 테스트

### 2.2 종목 시세 조회 API 테스트
- [ ] `inquire_price` API 기본 호출 테스트
- [ ] 삼성전자(005930) 현재가 조회 테스트
- [ ] 다양한 종목코드 조회 테스트
- [ ] API 응답 데이터 구조 분석
- [ ] 시장별 구분 코드 테스트 (KRX, NXT 등)

### 2.3 API 응답 데이터 매핑 테스트
- [ ] API 응답을 `state.py` 모델로 변환 테스트
- [ ] `PortfolioStatus` 모델 매핑 검증
- [ ] `StockInfo` 모델 매핑 검증
- [ ] 데이터 타입 변환 및 검증 로직 테스트
- [ ] 누락 데이터 처리 방안 테스트

### 2.4 종합 API 호출 시나리오 테스트
- [ ] 인증 → 잔고조회 → 종목시세 조회 전체 흐름 테스트
- [ ] 다중 API 호출 시 Rate limiting 검증
- [ ] 장시간 실행 시 토큰 만료 및 재발급 테스트
- [ ] 네트워크 오류 상황 대응 테스트

---

## Phase 3: LV1 Observer 프로젝트 통합

### 3.1 KIS 클라이언트 모듈 구현
- [ ] `src/kis_client.py` 생성 - 핵심 API 클라이언트
- [ ] 인증 관리 클래스 구현 (`KISAuth`)
- [ ] 포트폴리오 조회 클래스 구현 (`KISPortfolio`)
- [ ] 공통 API 호출 유틸리티 구현
- [ ] 설정 파일 통합 및 환경변수 관리

### 3.2 데이터 변환 및 검증 로직 구현
- [ ] API 응답 → `PortfolioStatus` 변환기 구현
- [ ] API 응답 → `StockInfo` 변환기 구현
- [ ] 데이터 유효성 검증 함수 구현
- [ ] 에러 데이터 처리 및 로깅 구현
- [ ] 빈 데이터/null 값 처리 로직 구현

### 3.3 LangGraph 노드 통합
- [ ] `graph.py`의 `fetch_portfolio_status` 노드 실제 구현
- [ ] KIS API 클라이언트 통합 및 호출
- [ ] 에러 처리 및 상태 업데이트 로직
- [ ] 테스트 모드와 실제 모드 분리 구현
- [ ] 로깅 및 디버깅 정보 추가

### 3.4 예외 처리 및 복구 로직 강화
- [ ] KIS API 전용 예외 클래스 확장
- [ ] 토큰 만료 시 자동 재발급 로직
- [ ] API 호출 실패 시 재시도 로직
- [ ] 네트워크 오류 대응 방안
- [ ] 그래프 실행 중단 시 복구 시나리오

---

## Phase 4: 통합 테스트 및 검증

### 4.1 개별 모듈 단위 테스트
- [ ] `tests/test_kis_client.py` 작성 및 실행
- [ ] 인증 모듈 단위 테스트
- [ ] 포트폴리오 조회 모듈 단위 테스트
- [ ] 데이터 변환 로직 단위 테스트
- [ ] 모든 단위 테스트 통과 확인

### 4.2 통합 테스트 수행
- [ ] LangGraph 전체 워크플로우 테스트
- [ ] `fetch_portfolio_status` 노드 실행 테스트
- [ ] 실제 API 연동 end-to-end 테스트
- [ ] 다양한 포트폴리오 상황 시나리오 테스트
- [ ] 성능 및 응답 시간 측정

### 4.3 에러 시나리오 테스트
- [ ] 잘못된 API 키로 테스트
- [ ] 네트워크 연결 오류 시뮬레이션
- [ ] API 응답 지연 시나리오 테스트
- [ ] 토큰 만료 상황 테스트
- [ ] 예상치 못한 데이터 형식 처리 테스트

### 4.4 문서화 및 가이드 작성
- [ ] KIS API 연동 가이드 작성
- [ ] 설정 방법 문서화
- [ ] 트러블슈팅 가이드 작성
- [ ] 코드 주석 및 docstring 보완
- [ ] API 사용량 및 제한사항 문서화

---

## Phase 5: 최종 검증 및 Phase 4 준비

### 5.1 실전 환경 준비 확인
- [ ] 모의투자 → 실전투자 전환 가이드 작성
- [ ] 실전 계좌 연동 테스트 (신중히)
- [ ] 보안 점검 (API 키 보호, 로그 민감정보 제거)
- [ ] 운영 환경 설정 최적화
- [ ] 모니터링 및 알림 시스템 구축

### 5.2 성능 최적화 및 안정성 강화
- [ ] API 호출 횟수 최적화
- [ ] 메모리 사용량 최적화
- [ ] 응답 시간 개선
- [ ] 연결 풀링 및 재사용 최적화
- [ ] 장애 복구 시간 단축

### 5.3 다음 Phase 준비
- [ ] `prompts/lv1_plan.md`의 Phase 3 체크박스 업데이트
- [ ] Phase 4 (뉴스 수집) 구현 요구사항 정리
- [ ] 네이버 뉴스 API 사전 조사
- [ ] 뉴스 수집 시스템 설계 초안 작성
- [ ] LLM 통합 (OpenAI API) 준비사항 점검

### 5.4 최종 검토 및 릴리스
- [ ] 전체 코드 리뷰 및 품질 확인
- [ ] 모든 테스트 케이스 통과 확인
- [ ] 문서 완성도 검토
- [ ] 보안 및 개인정보 보호 최종 점검
- [ ] Phase 3 완료 및 Phase 4 시작 준비 완료

---

## 추가 고려사항

### 보안 및 안정성
- [ ] API 키 암호화 저장 구현
- [ ] 로그에서 민감정보 제거
- [ ] Rate limiting 철저한 준수
- [ ] 비정상적 접근 패턴 모니터링

### 확장성 대비
- [ ] 다른 증권사 API 확장 가능성 고려
- [ ] API 버전 업그레이드 대응 방안
- [ ] 대용량 포트폴리오 처리 능력
- [ ] 다중 계좌 지원 확장성

### 사용자 경험
- [ ] API 연동 상태 실시간 표시
- [ ] 명확한 에러 메시지 및 해결 방안 제시
- [ ] 설정 과정 단순화 및 자동화
- [ ] 진행 상황 표시 및 예상 소요 시간 안내