# 주식자동매매 시스템 v2.0 고도화 개발 계획서 (Claude 작성)

> **기준 문서**: `docs/system_prd_0919.md` - 자기 개조 및 기술적 분석이 통합된 전문가 에이전트 팀 설계  
> **작성일**: 2025-09-19  
> **현재 상태**: Phase 2 완료 (단일 에이전트 Trading Graph)  
> **목표**: 하이브리드 LLM 기반 자기 진화 전문가 팀 시스템 구축

---

## 📋 1. 개요 및 현재 상태 분석

### 현재 시스템 (Phase 2 완료)

- **아키텍처**: 단일 LLM 기반 순차적 LangGraph 워크플로우
- **노드 구성**: 6개 노드 (포트폴리오 조회 → 시장 분석 → 거래 계획 → 검증 → 실행 → 기록)
- **LLM 전략**: OpenAI GPT 단일 모델 사용
- **학습 방식**: 정적 규칙 기반, 제한적 개선

### 목표 시스템 (v2.0)

- **아키텍처**: 하이브리드 LLM 기반 전문가 팀 + 자기 개조 시스템
- **노드 구성**: 운영 그래프 9개 노드 + 성찰/개조 그래프 5개 노드
- **LLM 전략**: Claude Opus 4.1, GPT-5, Gemini 2.5 Flash, Perplexity sonar-pro 전문 분야별 최적화
- **학습 방식**: 자기 성찰을 통한 LLM 모델 교체 및 프롬프트 진화

---

## 🏗️ 2. 시스템 아키텍처 변화 요약

### 핵심 혁신 요소

| 구분              | 기존 (v1.0)    | 신규 (v2.0)                         |
| ----------------- | -------------- | ----------------------------------- |
| **LLM 전략**      | 단일 GPT 모델  | 하이브리드 LLM 스택 (4개 모델)      |
| **에이전트 구조** | 6개 순차 노드  | 9개 전문가 에이전트 + 4개 병렬 분석 |
| **의사결정**      | 단일 AI 판단   | CIO 에이전트 종합 의사결정          |
| **학습 방식**     | 정적 규칙 개선 | 동적 모델 교체 및 자기 개조         |
| **분석 범위**     | 펀더멘털 중심  | 펀더멘털 + 기술적 분석 통합         |

---

## 🚀 Phase 1: 하이브리드 LLM 인프라 및 중앙 메모리 고도화

### 1.1 다중 LLM 클라이언트 통합 시스템 구축

#### 🔧 LLM 어댑터 패턴 구현

- [x] `src/llm_clients/` 디렉토리 생성 및 기본 구조 설계
- [x] `BaseAgentLLM` 추상 클래스 정의 (표준 인터페이스)
- [x] `ClaudeClient` 구현 (CIO 에이전트, 성찰 분석용)
- [x] `GPTClient` 구현 (테크니컬 분석, 고속 처리용)
- [x] `GeminiClient` 구현 (펀더멘털 분석용)
- [x] `PerplexityClient` 구현 (실시간 시장 리서치용)
- [x] API 키 관리 및 요청 제한 처리 로직
- [x] 응답 정규화 및 에러 핸들링 공통 모듈

#### ⚙️ 에이전트별 LLM 설정 관리 시스템

- [x] `config/agent_llm_mapping.yaml` 설정 파일 생성
- [x] 에이전트별 최적 LLM 매핑 규칙 정의
- [x] 동적 모델 교체를 위한 설정 업데이트 API
- [x] 비용 모니터링 및 제한 시스템 (일일/주간 한도)
- [x] LLM 응답 품질 메트릭 수집 (응답 시간, 성공률)

### 1.2 중앙 데이터베이스 확장 및 성과 추적 시스템

#### 📊 데이터베이스 스키마 확장

- [x] `TradeRecord` 테이블에 에이전트별 기여도 필드 추가
- [x] `AgentPerformance` 테이블 신규 생성 (에이전트별 성과 추적)
- [x] `LLMUsageLog` 테이블 신규 생성 (모델별 사용량 및 비용)
- [x] `ModelEvolutionHistory` 테이블 신규 생성 (모델 교체 이력)
- [x] 데이터베이스 마이그레이션 스크립트 작성 및 테스트

#### 🔍 성과 분석 및 기여도 측정 시스템

- [x] 에이전트별 의사결정 기여도 계산 알고리즘
- [x] 거래 성과와 에이전트 분석의 상관관계 추적
- [x] LLM 모델별 성과 벤치마킹 데이터 수집
- [x] 실시간 성과 대시보드 데이터 파이프라인

### 1.3 통합 테스트 및 검증

#### ✅ 시스템 통합 검증

- [x] 다중 LLM 동시 호출 부하 테스트
- [x] API 사용량 추적 시스템 검증
- [x] 데이터베이스 확장 기능 통합 테스트
- [x] 에러 복구 및 폴백 메커니즘 검증

---

## 🎯 Phase 2: 전문가 팀 기반 운영 그래프 구현 (9개 노드)

### 2.1 전처리 및 데이터 수집 에이전트 (노드 1-4)

#### 🔄 노드 1: 리밸런싱 에이전트 (GPT-5 nano)

- [x] 포트폴리오 진단 로직 구현
- [x] 섹터별/종목별 비중 분석 알고리즘
- [x] 리밸런싱 필요도 스코어링 시스템
- [x] KIS API 연동 포트폴리오 데이터 수집

#### 🔍 노드 2: 섹터 리서치 에이전트 (Perplexity sonar-pro) ✅

- [x] 실시간 웹 검색 기반 섹터 트렌드 분석
- [x] 유망 섹터 발굴 및 순위 매기기
- [x] 뉴스 감정 분석 및 시장 모멘텀 측정
- [x] 섹터 로테이션 신호 감지 시스템

#### 📋 노드 3: 거래가능 티커 스크리너

- [ ] KIS API를 통한 종목별 매매가능 여부 확인
- [ ] 매매가능 종목 리스트 생성 및 노드4 전달

#### 📈 노드 4: 펀더멘털 페처 에이전트 (Gemini 2.5 Flash-Lite)

- [ ] KIS API를 통한 재무제표 데이터 수집 및 구조화 (PER, PBR, ROE 등)
- [ ] 기본 필터링 조건 설정 및 적용 (시가총액, 거래량 기준)
- [ ] 공시 정보 및 뉴스 데이터 수집
- [ ] 동종업계 비교 데이터 준비 및 종목 순위 매기기
- [ ] 데이터 품질 검증 및 정제 시스템

### 2.2 병렬 분석 전문가 팀 (노드 5a-5d)

#### 💰 노드 5a: 밸류에이션 분석가 (Gemini 2.5 Flash)

- [ ] DCF, PER, PBR 등 멀티플 밸류에이션 모델
- [ ] 내재가치 산정 및 저평가 종목 발굴
- [ ] 업종별 밸류에이션 기준 비교 분석
- [ ] 가치 투자 관점 종합 리포트 생성

#### 💸 노드 5b: 자금 흐름 분석가 (Gemini 2.5 Flash)

- [ ] 기관/외국인 수급 동향 분석
- [ ] 거래량 패턴 및 대량 거래 감지
- [ ] 자금 이동 경로 추적 (섹터 간 이동)
- [ ] 스마트 머니 추종 전략 신호 생성

#### ⚠️ 노드 5c: 리스크 분석가 (Gemini 2.5 Flash)

- [ ] 포트폴리오 위험도 측정 (VaR, 베타 등)
- [ ] 상관관계 분석 및 다각화 효과 평가
- [ ] 섹터/테마 집중도 리스크 경고
- [ ] 최대 손실 한도 및 포지션 사이징 권고

#### 📊 노드 5d: 테크니컬 애널리스트 (GPT-5) ⭐

- [ ] 차트 패턴 인식 및 분석 (헤드앤숄더, 삼각수렴 등)
- [ ] 이동평균선, RSI, MACD 등 기술적 지표 분석
- [ ] 지지선/저항선 계산 및 돌파 신호 감지
- [ ] 거래량 분석과 가격 액션 상관관계
- [ ] 단기/중기 매매 타이밍 최적화 권고

### 2.3 최종 의사결정 및 실행 (노드 6-9)

#### 🎖️ 노드 6: CIO 에이전트 (Claude Opus 4.1)

- [ ] 4개 전문가 리포트 종합 분석 시스템
- [ ] 펀더멘털 vs 테크니컬 분석 가중치 동적 조정
- [ ] 리스크 대비 수익률 최적화 의사결정
- [ ] 의사결정 근거 및 신뢰도 스코어 제공
- [ ] 시장 상황별 투자 전략 자동 조정

#### 💼 노드 7: 알로케이터 에이전트 (GPT-5 nano)

- [ ] 자금 관리 모델에 따른 투자 규모 결정
- [ ] 켈리 공식 기반 최적 포지션 사이징
- [ ] 리스크 한도 내 최대 수익 추구 로직
- [ ] 긴급 상황 시 포지션 축소 규칙

#### 📝 노드 8: 트레이드 플래너 에이전트 (GPT-5 nano)

- [ ] 최종 투자 계획을 KIS API 주문 형식으로 변환
- [ ] 분할 매수/매도 전략 수립
- [ ] 주문 타이밍 최적화 (시장 상황 고려)
- [ ] 실행 전 최종 리스크 체크

#### ⚡ 노드 9: 실행 및 기록

- [ ] KIS API를 통한 주문 실행
- [ ] 실행 결과 실시간 모니터링
- [ ] 모든 에이전트 분석 과정 데이터베이스 기록
- [ ] 실행 실패 시 알림 및 대응 프로세스

---

## 🧠 Phase 3: 성찰 및 자기 개조 그래프 구현 (5개 노드)

### 3.1 성과 분석 및 학습 데이터 생성

#### 📈 노드 M1: 성과 데이터 집계

- [ ] 주간/월간 거래 성과 자동 집계 시스템
- [ ] 에이전트별 의사결정 기여도 분석
- [ ] 손실 거래에 대한 상세 분석 데이터 추출
- [ ] 벤치마크 대비 성과 비교 리포트

#### 🔍 노드 M2: 실패 원인 귀인 분석 (Claude Opus 4.1)

- [ ] 손실 거래의 근본 원인 분석 (펀더멘털 vs 타이밍 오류)
- [ ] 에이전트별 실패 패턴 식별
- [ ] 시장 상황별 에이전트 성과 차이 분석
- [ ] 실패 책임 에이전트 특정 알고리즘

### 3.2 LLM 모델 성능 최적화 시스템

#### ⚖️ 노드 M2.5: 모델 성능 벤치마킹 엔진 (Claude Opus 4.1)

- [ ] 실패 상황 재현 시뮬레이션 시스템
- [ ] 대체 LLM 모델들의 성과 비교 테스트
- [ ] 모델별 강점/약점 프로파일링
- [ ] 비용 대비 성과 효율성 분석
- [ ] A/B 테스트 기반 모델 성능 검증

#### 🎯 노드 M3: 최적 개선 전략 생성 (Claude Opus 4.1)

- [ ] 모델 교체 vs 프롬프트 개선 의사결정 로직
- [ ] 신규 행동 규칙 생성 알고리즘
- [ ] 개선 효과 예측 모델
- [ ] 리스크 고려 개선 우선순위 결정

### 3.3 자동 시스템 진화 실행

#### 🔧 노드 M4: 시스템 구성 자동 업데이트

- [ ] `agent_llm_mapping.yaml` 자동 수정 시스템
- [ ] 에이전트별 프롬프트 파일 동적 업데이트
- [ ] 변경 사항 버전 관리 및 롤백 시스템
- [ ] 관리자 승인 워크플로우 (중요 변경 시)
- [ ] 진화 내역 상세 로깅 및 리포팅

#### 📊 성찰 그래프 모니터링 시스템

- [ ] 자기 개조 효과 실시간 추적
- [ ] 무한 루프 방지 안전장치
- [ ] 개선 효과 검증 및 성과 측정
- [ ] 비정상적 학습 패턴 조기 감지

---

## 🧪 Phase 4: 통합 테스트 및 자기 진화 시스템 검증

### 4.1 전체 시스템 통합 테스트

#### 🔄 워크플로우 통합 검증

- [ ] 운영 그래프 ↔ 성찰 그래프 데이터 흐름 검증
- [ ] 9개 에이전트 간 협업 프로세스 테스트
- [ ] 동시 다중 LLM 호출 부하 테스트
- [ ] 메모리 사용량 및 성능 최적화

#### 📈 모의 거래 시뮬레이션

- [ ] 과거 데이터 기반 백테스팅 시스템
- [ ] 다양한 시장 상황별 시나리오 테스트
- [ ] 자기 개조 효과 장기간 시뮬레이션
- [ ] 비용 대비 성과 효율성 검증

### 4.2 안전성 및 리스크 관리 검증

#### 🛡️ 시스템 안전장치 테스트

- [ ] 자기 개조 무한 루프 방지 테스트
- [ ] LLM API 장애 시 폴백 메커니즘 검증
- [ ] 과도한 모델 교체 방지 시스템 테스트
- [ ] 비정상 의사결정 감지 및 차단 시스템

#### 💰 비용 관리 및 모니터링

- [ ] 일일/주간/월간 LLM 사용 비용 추적
- [ ] 비용 한도 초과 시 자동 제한 시스템
- [ ] 모델별 비용 효율성 모니터링
- [ ] 비용 최적화 권고 시스템

---

## 🚀 Phase 5: 프로덕션 배포 및 지속적 모니터링

### 5.1 프로덕션 환경 준비

#### 🏗️ 배포 인프라 구축

- [ ] 프로덕션 환경 설정 및 보안 강화
- [ ] CI/CD 파이프라인 구축 (자동 배포)
- [ ] 모니터링 및 알림 시스템 구축
- [ ] 데이터 백업 및 복구 시스템

#### 📋 운영 문서 및 가이드

- [ ] 시스템 운영 매뉴얼 작성
- [ ] 장애 대응 플레이북 수립
- [ ] 성능 최적화 가이드라인
- [ ] 사용자 교육 자료 제작

### 5.2 지속적 개선 및 모니터링

#### 📊 성과 모니터링 대시보드

- [ ] 실시간 거래 성과 모니터링
- [ ] 에이전트별 기여도 시각화
- [ ] LLM 모델 성능 트렌드 분석
- [ ] 자기 개조 효과 추적 차트

#### 🔄 지속적 개선 프로세스

- [ ] 주간 성과 리뷰 및 개선 계획 수립
- [ ] 신규 LLM 모델 평가 및 도입 검토
- [ ] 사용자 피드백 반영 프로세스
- [ ] 시장 변화에 따른 전략 조정

---

## ⚠️ 위험 요소 및 대응 방안

### 기술적 위험 요소

#### 🔴 높은 위험도

- **LLM API 의존성**: 여러 외부 API 장애 시 시스템 마비
  - ✅ **대응**: 각 LLM별 폴백 모델 및 로컬 모델 백업 시스템
- **과도한 자기 개조**: 시스템이 비정상적으로 진화하여 성과 악화
  - ✅ **대응**: 변경 승인 시스템, 성과 임계값 기반 자동 롤백

#### 🟡 중간 위험도

- **높은 운영 비용**: 다중 LLM 사용으로 인한 예상 비용 초과
  - ✅ **대응**: 실시간 비용 모니터링, 자동 사용량 제한, 모델 효율성 최적화
- **복잡성 증가**: 14개 노드 시스템의 디버깅 및 유지보수 어려움
  - ✅ **대응**: 체계적 로깅, 노드별 독립 테스트, 단계적 배포

### 시장 위험 요소

#### 🔴 높은 위험도

- **시장 급변 상황**: 블랙스완 이벤트 시 AI 시스템 오판 가능성
  - ✅ **대응**: 인간 개입 시스템, 손실 한도 설정, 긴급 매도 프로토콜

#### 🟡 중간 위험도

- **규제 변화**: 금융 AI 규제 강화로 인한 시스템 제약
  - ✅ **대응**: 규제 준수 모니터링, 감사 로그 시스템, 투명성 강화

---

## 📅 개발 일정 및 마일스톤

### 전체 개발 타임라인 (16주)

| Phase       | 기간 | 핵심 목표                  | 주요 산출물                         |
| ----------- | ---- | -------------------------- | ----------------------------------- |
| **Phase 1** | 3주  | 하이브리드 LLM 인프라 구축 | 다중 LLM 클라이언트, 확장된 DB      |
| **Phase 2** | 5주  | 전문가 팀 운영 그래프 구현 | 9개 에이전트 노드, 병렬 분석 시스템 |
| **Phase 3** | 4주  | 성찰/자기 개조 그래프 구현 | 5개 학습 노드, 자동 진화 시스템     |
| **Phase 4** | 2주  | 통합 테스트 및 검증        | 전체 시스템 테스트, 안전장치 검증   |
| **Phase 5** | 2주  | 프로덕션 배포 및 모니터링  | 운영 시스템, 모니터링 대시보드      |

### 주요 체크포인트

#### 🎯 Phase 1 완료 (3주차)

- [ ] 4개 LLM 클라이언트 통합 완료
- [ ] 데이터베이스 확장 및 마이그레이션 완료
- [ ] 비용 모니터링 시스템 가동

#### 🎯 Phase 2 완료 (8주차)

- [ ] 9개 전문가 에이전트 구현 완료
- [ ] CIO 에이전트 종합 의사결정 시스템 가동
- [ ] 테크니컬 분석 통합 검증

#### 🎯 Phase 3 완료 (12주차)

- [ ] 자기 개조 시스템 구현 완료
- [ ] 첫 번째 자동 모델 교체 성공
- [ ] 성찰 그래프 안정성 검증

#### 🎯 Phase 4 완료 (14주차)

- [ ] 전체 시스템 통합 테스트 통과
- [ ] 과거 데이터 백테스팅 검증 완료
- [ ] 안전장치 시스템 검증 완료

#### 🎯 Phase 5 완료 (16주차)

- [ ] 프로덕션 배포 완료
- [ ] 실시간 모니터링 시스템 가동
- [ ] 첫 1주간 안정적 운영 확인

---

## 📝 체크리스트 요약

### 🏁 전체 진행 상황 추적

#### Phase 1: 인프라 구축 (20/20) ✅ 완료

- [x] LLM 클라이언트 통합 (8/8) ✅ 완료
- [x] 설정 관리 시스템 (5/5) ✅ 완료
- [x] 데이터베이스 확장 (5/5) ✅ 완료
- [x] 통합 테스트 (4/4) ✅ 완료

#### Phase 2: 운영 그래프 (4/29) - 노드3 재정의로 체크리스트 리셋

- [x] 전처리 에이전트 노드1 (4/4) - 리밸런싱 에이전트 완료
- [x] 전처리 에이전트 노드2 (4/4) - 섹터 리서치 에이전트 완료
- [ ] 거래가능 스크리너 노드3 (0/4) - 매매가능 여부 확인으로 재정의
- [ ] 펀더멘털 페처 노드4 (0/5) - 재무지표 스크리닝 기능 추가
- [ ] 병렬 분석 에이전트 (0/12)
- [ ] 의사결정 및 실행 (0/4)

#### Phase 3: 성찰 그래프 (0/15)

- [ ] 성과 분석 시스템 (0/4)
- [ ] 모델 최적화 시스템 (0/6)
- [ ] 자동 업데이트 시스템 (0/5)

#### Phase 4: 통합 검증 (0/10)

- [ ] 시스템 통합 테스트 (0/6)
- [ ] 안전성 검증 (0/4)

#### Phase 5: 배포 및 운영 (0/12)

- [ ] 프로덕션 배포 (0/6)
- [ ] 지속적 모니터링 (0/6)

**전체 진행률: 28/86 (32.6%)** - 노드3 재정의로 업데이트

---

_이 계획서는 `docs/system_prd_0919.md`의 자기 개조 전문가 팀 설계를 기반으로 작성되었으며, 체크박스를 통해 개발 진행 상황을 실시간으로 추적할 수 있도록 구성되었습니다._
