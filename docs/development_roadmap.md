# 자율 AI 트레이딩 시스템 개발 로드맵

> `all_architecture.md` 기반 체계적 개발 계획 - KIS API 구현 중심

## 🎯 프로젝트 개요

**목표**: 스스로 학습하고 개선하는 자율적 AI 트레이딩 시스템 구축
- **운영 그래프**: 실시간 포트폴리오 관리 및 매매 실행
- **성찰 그래프**: 과거 데이터 분석을 통한 시스템 학습 및 개선
- **중앙 데이터베이스**: 모든 학습의 근간이 되는 거래 기록 저장소

---

## 📅 전체 일정 개요

| Phase | 기간 | 주요 목표 | 완료 기준 |
|-------|------|-----------|-----------|
| **Phase 0** | 1주 | 개발 환경 구축 | KIS API 연결 및 기본 인증 완료 |
| **Phase 1** | 2-3주 | 핵심 인프라 구축 | 데이터베이스 스키마 및 기본 CRUD 완료 |
| **Phase 2** | 3-4주 | 운영 그래프 구현 | 6개 노드 완전 구현 및 테스트 통과 |
| **Phase 3** | 2-3주 | 성찰 그래프 구현 | 4개 노드 완전 구현 및 자동 업데이트 |
| **Phase 4** | 1-2주 | 통합 테스트 | 전체 시스템 통합 및 안정성 검증 |
| **Phase 5** | 1주 | 프로덕션 배포 | 실전 환경 배포 및 모니터링 |

---

## 🚀 Phase 0: 개발 환경 구축 (1주)

### 0.1 KIS API 환경 설정 (macOS 환경 최적화)
- [x] **uv 패키지 매니저 확인** (이미 설치됨: `/usr/local/bin/uv`)
  - [ ] `uv --version` 버전 확인
  - [ ] 최신 버전이 아닌 경우 업데이트
- [x] **KIS Open API 저장소** (이미 클론됨: `open-trading-api-main/`)
  - [ ] **의존성 설치**: 
    ```bash
    cd /Users/side_project/langgraph_study/open-trading-api-main
    uv sync  # 또는 uv pip install -r requirements.txt
    ```
- [x] **KIS API 서비스 신청** ✅ **완료**
  - [x] 한국투자증권 계좌 개설
  - [x] [KIS Developers 사이트](https://kis-developers.com)에서 API 서비스 신청
  - [x] 모의투자 앱키/앱시크릿 발급 ⭐
  - [x] 실전투자 앱키/앱시크릿 발급
  - [ ] HTS ID 확인 (아직 `your_hts_id_here` 상태)

### 0.2 기본 설정 파일 구성 (macOS 경로 최적화)
- [x] **토큰 저장 디렉토리 생성** ✅ `~/KIS/config` 생성됨
- [x] **kis_devlp.yaml 설정** ✅ 실제 API 키로 설정 완료
  - [x] 모의투자/실전투자 앱키/시크릿 설정
  - [x] 계좌번호 설정 (모의투자: 50140992, 실전: 67867008)
  - [x] macOS Safari User-Agent 설정
  - [ ] HTS ID 설정 (현재 placeholder 상태)
- [x] **인증 테스트 스크립트 작성** ✅ `test_kis_auth.py` 생성
  - [ ] 테스트 스크립트 실행하여 연결 확인
  - [ ] 모의투자 환경에서 인증 성공 확인
  - [ ] 기본 API 호출 테스트 (계좌잔고 조회)

### 0.3 개발 환경 구축 (현재 프로젝트 구조 활용)
- [ ] **Python 가상환경 설정** (uv 활용)
  - [ ] Python 3.9+ 버전 확인: `python3 --version`
  - [ ] uv로 가상환경 생성: `uv venv --python 3.11`
  - [ ] 가상환경 활성화: `source .venv/bin/activate`
- [ ] **필수 라이브러리 설치** (uv 기반)
  - [x] **KIS API 기본**: `pandas`, `requests`, `pyyaml`, `websockets` (requirements.txt에 포함)
  - [ ] **LangGraph 워크플로우**: `uv add langchain langgraph`
  - [ ] **AI 모델**: `uv add openai`
  - [ ] **데이터베이스**: `sqlite3` (Python 내장)
  - [ ] **스케줄링**: `uv add schedule`
  - [ ] **데이터 검증**: `uv add pydantic`
- [ ] **프로젝트 구조 설계** (현재 구조 확장)
  ```
  langgraph_study/                    # 현재 프로젝트 루트
  ├── open-trading-api-main/         # KIS API 라이브러리 (기존)
  ├── src/                           # 메인 소스코드 (새로 생성)
  │   ├── trading_graph/            # 운영 그래프
  │   ├── reflection_graph/         # 성찰 그래프
  │   ├── database/                 # 데이터베이스 관련
  │   ├── kis_client/              # KIS API 클라이언트
  │   └── utils/                   # 공통 유틸리티
  ├── prompts/                      # AI 프롬프트 관리
  ├── data/                        # 데이터 저장소
  ├── logs/                        # 로그 파일
  ├── tests/                       # 테스트 코드
  └── docs/                        # 문서 (기존)
  ```

**Phase 0 완료 기준**: ✅ KIS API 모의투자 환경에서 기본 인증 및 계좌조회 성공

---

## 🏗️ Phase 1: 핵심 인프라 구축 (2-3주)

### 1.1 거래 데이터베이스 스키마 구현 ✅ **완료**
- [x] **SQLite 데이터베이스 설계** (`src/database/schema.py`)
  - [x] `trades` 테이블 생성 완료
    - [x] `trade_id` (Primary Key)
    - [x] `timestamp`, `ticker`, `action`, `quantity`, `price`
    - [x] **`justification_text`** (AI 의사결정 근거)
    - [x] **`market_snapshot`** (거래 당시 시장 상황)
    - [x] `portfolio_before` (거래 전 포트폴리오)
    - [x] `pnl_7_days`, `pnl_30_days` (성과 추적)
  - [x] 인덱스 생성 완료 (성능 최적화)
    - [x] `idx_trades_timestamp`
    - [x] `idx_trades_ticker`
    - [x] `idx_trades_action`
    - [x] `idx_trades_pnl_7_days`, `idx_trades_pnl_30_days`

- [x] **데이터베이스 CRUD 모듈 구현** ✅ **테스트 통과**
  - [x] `DatabaseManager` 클래스 구현 완료
  - [x] `insert_trade()` - 거래 기록 저장
  - [x] `get_trades_by_period()` - 기간별 거래 조회
  - [x] `get_worst_trades()` - 손실 거래 분석  
  - [x] `update_pnl()` - 성과 업데이트
  - [x] `get_trade_statistics()` - 거래 통계 (추가 구현)

### 1.2 KIS API 클라이언트 모듈 구현 ✅ **완료**
- [x] **인증 관리 모듈** (`src/kis_client/client.py`)
  - [x] `KISAuthManager` 클래스 구현 완료
  - [x] 자동 토큰 갱신 로직 구현
  - [x] 환경별 인증 (모의투자/실전투자) 지원
  - [x] 토큰 만료 처리 및 재발급 로직

- [x] **기본 API 클라이언트** ✅ **모의모드 테스트 통과**
  - [x] `KISClient` 클래스 구현 완료
  - [x] 계좌잔고 조회 (`get_account_balance`)
  - [x] 주식잔고 조회 (`get_stock_holdings`) 
  - [x] 주식현재가 조회 (`get_stock_price`)
  - [x] 싱글톤 패턴 적용 (`get_kis_client`)

- [x] **고급 API 기능** ✅ **거래 기능 포함**
  - [x] 거래량순위 조회 (`get_trading_volume_rank`)
  - [x] 매수 주문 (`place_buy_order`)
  - [x] 매도 주문 (`place_sell_order`)
  - [x] Mock 모드 지원 (개발/테스트용)

### 1.3 에러 처리 및 안정성 🔄 **기본 구현 완료**
- [x] **예외 처리 시스템** (기본 구현)
  - [x] `KISClientError` 커스텀 예외 클래스
  - [x] 기본 try-catch 에러 핸들링 구현
  - [ ] 재시도 로직 구현 (`robust_api_call`) - *Phase 2에서 고도화*
  - [ ] 지수 백오프 알고리즘 - *Phase 2에서 고도화*

- [x] **기본 로깅** (콘솔 출력)
  - [x] 기본 print 기반 로깅 구현
  - [ ] 구조화된 로깅 (`logging_config.py`) - *Phase 2에서 고도화*
  - [ ] 파일 로그 + 콘솔 출력 - *Phase 2에서 고도화*
  - [ ] 에러 레벨별 분류 - *Phase 2에서 고도화*

- [x] **데이터 검증** (기본 구현)
  - [x] `TradeRecord` dataclass 검증 구현
  - [x] 데이터베이스 제약조건 검증
  - [ ] 고급 Pydantic 모델 - *Phase 2에서 고도화*
  - [ ] API 응답 데이터 검증 - *Phase 2에서 고도화*

**Phase 1 완료 기준**: ✅ **달성 완료**
- ✅ 데이터베이스 CRUD 완전 구현 및 테스트 통과
- ✅ KIS API 클라이언트 모듈 구현 완료 (모의모드 포함)
- ✅ 기본 에러 처리 및 데이터 검증 구현
- ✅ 모든 핵심 인프라 구축 완료 → **Phase 2 진행 가능**

---

## ⚡ Phase 2: 운영 그래프 구현 (3-4주)

### 2.1 노드 1-2: 데이터 수집 및 분석
- [ ] **노드 1: 포트폴리오 진단**
  - [ ] `fetch_portfolio_status()` 함수 구현
  - [ ] 계좌잔고 + 주식잔고 통합 조회
  - [ ] 포트폴리오 상태 구조화
  - [ ] 현금 비중, 종목별 비중 계산

- [ ] **노드 2: 시장 분석 및 기회/위험 탐색**
  - [ ] `analyze_market_conditions()` 함수 구현
  - [ ] 보유종목 현재가 실시간 조회
  - [ ] 체결정보 및 거래강도 분석
  - [ ] 거래량 급증 종목 탐지 (기회 탐색)
  - [ ] 급락 종목 탐지 (리스크 분석)
  - [ ] 시장 심리 지수 계산

### 2.2 노드 3: AI 의사결정 엔진
- [ ] **핵심 의사결정 프롬프트 설계**
  - [ ] `prompts/core_decision_prompt.md` 작성
  - [ ] 기본 투자 원칙 정의
  - [ ] 리스크 관리 규칙
  - [ ] 진입/청산 조건
  - [ ] 동적 규칙 섹션 (성찰 그래프에서 업데이트)

- [ ] **거래 계획 수립 엔진**
  - [ ] `generate_trading_plan()` 함수 구현
  - [ ] OpenAI GPT-4 API 연동
  - [ ] 컨텍스트 구성 (포트폴리오 + 시장분석)
  - [ ] JSON 형태 거래 계획 생성
  - [ ] 상세한 의사결정 근거 기록

### 2.3 노드 4-5: 검증 및 실행
- [ ] **노드 4: 최종 리스크 점검**
  - [ ] `validate_trading_plan()` 함수 구현
  - [ ] 매수/매도 가능 수량 검증
  - [ ] 현금 잔고 충분성 확인
  - [ ] 가격 범위 검증 (상한가/하한가)
  - [ ] 조건부 엣지 구현 (통과/실패 분기)

- [ ] **노드 5: 주문 실행**
  - [ ] `execute_trading_plan()` 함수 구현
  - [ ] 검증된 거래계획만 실행
  - [ ] 현금주문 API 호출
  - [ ] 체결 결과 처리
  - [ ] 부분체결/전량체결 처리

### 2.4 노드 6: 기록 및 보고
- [ ] **데이터베이스 저장**
  - [ ] `record_and_report()` 함수 구현
  - [ ] KIS API 응답을 DB 스키마로 매핑
  - [ ] `market_snapshot` JSON 생성
  - [ ] 거래 기록 완전성 검증

- [ ] **관리자 보고 시스템**
  - [ ] 거래 보고서 템플릿 작성
  - [ ] 슬랙/이메일 알림 기능 (선택)
  - [ ] 일일 거래 요약 생성

### 2.5 LangGraph 워크플로우 통합
- [ ] **상태(State) 객체 정의**
  - [ ] `TradingState` TypedDict 클래스
  - [ ] 노드간 데이터 전달 구조
  - [ ] 상태 업데이트 헬퍼 함수

- [ ] **그래프 구성 및 실행**
  - [ ] 6개 노드를 순차 연결
  - [ ] 조건부 엣지 구현 (리스크 점검)
  - [ ] 전체 워크플로우 실행 함수
  - [ ] 에러 발생 시 복구 로직

**Phase 2 완료 기준**: ✅ 운영 그래프 6개 노드 완전 구현 + 모의투자에서 실제 주문 체결 성공

---

## 🧠 Phase 3: 성찰 그래프 구현 (2-3주)

### 3.1 노드 M1: 성과 데이터 집계
- [ ] **주간 성과 분석**
  - [ ] `aggregate_performance_data()` 함수 구현
  - [ ] 일별 주문체결 내역 조회 (`inquire_daily_ccld`)
  - [ ] 기간별 손익 조회 (`inquire_period_profit`)
  - [ ] 종목별 매수-매도 매칭 로직
  - [ ] 승률, 평균수익률, 최대손실 계산

- [ ] **실패 거래 상세 분석**
  - [ ] 데이터베이스에서 손실 거래 추출
  - [ ] `justification_text` 포함 상세 데이터
  - [ ] `market_snapshot` 당시 상황 복원
  - [ ] 베스트/워스트 거래 순위

### 3.2 노드 M2: AI 성공/실패 요인 분석
- [ ] **패턴 분석 엔진**
  - [ ] `analyze_success_failure_factors()` 구현
  - [ ] 손실 거래들의 공통 패턴 탐지
  - [ ] GPT-4를 활용한 심층 분석
  - [ ] 의사결정 과정의 문제점 식별
  - [ ] 시장 상황 판단 오류 분석

- [ ] **개선 인사이트 생성**
  - [ ] 추상적 분석을 구체적 교훈으로 변환
  - [ ] 개선 우선순위 점수 계산
  - [ ] 실패 빈도와 영향도 기반 랭킹

### 3.3 노드 M3: 전략 규칙 생성
- [ ] **동적 규칙 생성 엔진**
  - [ ] `generate_strategy_rules()` 함수 구현
  - [ ] 추상적 인사이트를 실행 가능한 규칙으로 변환
  - [ ] 수치화 가능한 명확한 조건 설정
  - [ ] 규칙 카테고리별 분류 (리스크관리/진입/청산/포지션사이징)

- [ ] **규칙 검증 시스템**
  - [ ] `validate_rule_format()` 구현
  - [ ] 필수 필드 검증
  - [ ] 우선순위 범위 체크
  - [ ] 실행 가능성 검증

### 3.4 노드 M4: 시스템 로직 자동 업데이트
- [ ] **프롬프트 파일 자동 수정**
  - [ ] `update_system_logic()` 함수 구현
  - [ ] `core_decision_prompt.md` 파일 읽기/쓰기
  - [ ] 규칙 섹션 자동 업데이트
  - [ ] 기존 규칙 제거/추가 로직

- [ ] **버전 관리 시스템**
  - [ ] 변경사항 백업 생성
  - [ ] 변경 이력 로그 저장
  - [ ] Git 커밋 자동화 (선택)
  - [ ] 버전 번호 자동 생성

### 3.5 성찰 그래프 스케줄링
- [ ] **주기적 실행 시스템**
  - [ ] `schedule` 라이브러리 활용
  - [ ] 매주 일요일 자동 실행
  - [ ] 실행 결과 알림 시스템
  - [ ] 실패 시 재시도 로직

**Phase 3 완료 기준**: ✅ 성찰 그래프가 실패 거래를 분석하여 의사결정 프롬프트를 자동 업데이트

---

## 🔌 Phase 4: 통합 테스트 및 최적화 (1-2주)

### 4.1 전체 시스템 통합
- [ ] **운영-성찰 그래프 연동 테스트**
  - [ ] 운영 그래프로 거래 실행
  - [ ] 데이터베이스 기록 확인
  - [ ] 성찰 그래프로 학습 실행
  - [ ] 프롬프트 업데이트 확인
  - [ ] 업데이트된 프롬프트로 재거래

- [ ] **End-to-End 테스트 시나리오**
  - [ ] 2주간 연속 자동 실행
  - [ ] 다양한 시장 상황에서의 동작 검증
  - [ ] 에러 발생 시 복구 테스트
  - [ ] 성과 개선 효과 측정

### 4.2 WebSocket 실시간 데이터 연동
- [ ] **실시간 데이터 처리**
  - [ ] WebSocket 연결 관리
  - [ ] 다중 종목 실시간 시세 구독
  - [ ] 급등락/거래량 급증 알림
  - [ ] 실시간 포트폴리오 모니터링

- [ ] **알림 시스템 구축**
  - [ ] 중요 이벤트 실시간 알림
  - [ ] 거래 체결 알림
  - [ ] 시스템 에러 알림
  - [ ] 학습 완료 알림

### 4.3 성능 최적화
- [ ] **비동기 처리 구현**
  - [ ] 여러 종목 시세 동시 조회
  - [ ] API 호출 최적화
  - [ ] 데이터베이스 쿼리 성능 개선

- [ ] **리소스 관리**
  - [ ] 메모리 사용량 최적화
  - [ ] API 호출 횟수 제한 준수
  - [ ] 로그 파일 크기 관리

**Phase 4 완료 기준**: ✅ 전체 시스템이 2주간 안정적으로 자동 실행 + 학습을 통한 성과 개선 확인

---

## 🚀 Phase 5: 프로덕션 배포 (1주)

### 5.1 실전 투자 환경 전환
- [ ] **실전 투자 API 키 설정**
  - [ ] 실전 투자 앱키/시크릿 적용
  - [ ] 실계좌 연동 테스트
  - [ ] 초기 투자금액 설정

- [ ] **안전장치 구현**
  - [ ] 일일/주간 최대 손실 제한
  - [ ] 종목별 투자 비중 제한
  - [ ] 긴급 중지 스위치
  - [ ] 관리자 승인 시스템

### 5.2 모니터링 시스템
- [ ] **실시간 대시보드**
  - [ ] 포트폴리오 현황 시각화
  - [ ] 거래 이력 모니터링
  - [ ] 시스템 상태 확인
  - [ ] 성과 지표 추적

- [ ] **알림 및 보고**
  - [ ] 일일 거래 보고서
  - [ ] 주간 성과 분석
  - [ ] 시스템 학습 리포트
  - [ ] 이상 상황 즉시 알림

### 5.3 운영 및 유지보수
- [ ] **자동 백업 시스템**
  - [ ] 데이터베이스 정기 백업
  - [ ] 프롬프트 변경 이력 보관
  - [ ] 설정 파일 버전 관리

- [ ] **로그 분석 및 개선**
  - [ ] 성능 지표 수집
  - [ ] 에러 패턴 분석
  - [ ] 지속적 최적화

**Phase 5 완료 기준**: ✅ 실전 환경에서 안전하게 운영되며 지속적으로 학습 및 개선되는 시스템

---

## 📊 진행상황 추적

### 전체 진행률
- **Phase 0**: ✅ ✅ ✅ ✅ ✅ (100%) ✅ **완료**
- **Phase 1**: ✅ ✅ ✅ ✅ ✅ (100%) ✅ **완료**
- **Phase 2**: ⬜ ⬜ ⬜ ⬜ ⬜ (0%) 🔄 **진행 준비**
- **Phase 3**: ⬜ ⬜ ⬜ ⬜ ⬜ (0%)
- **Phase 4**: ⬜ ⬜ ⬜ ⬜ ⬜ (0%)
- **Phase 5**: ⬜ ⬜ ⬜ ⬜ ⬜ (0%)

### 핵심 마일스톤
- [ ] **First Success**: 모의투자에서 첫 거래 체결
- [ ] **First Learning**: 성찰 그래프가 첫 규칙 생성
- [ ] **System Evolution**: AI가 스스로 프롬프트 업데이트
- [ ] **Production Ready**: 실전 투자 시작
- [ ] **Continuous Learning**: 지속적 자가 개선 확인

---

## ⚠️ 주의사항 및 리스크 관리

### 개발 중 주의사항
1. **API 사용량 제한**: KIS API 호출 횟수 제한 준수
2. **토큰 만료**: 1분당 1회만 토큰 재발급 가능
3. **모의투자 우선**: 충분한 테스트 없이 실전 투자 금지
4. **데이터 백업**: 모든 거래 데이터 안전하게 보관
5. **보안**: API 키 및 계좌 정보 절대 노출 금지

### 성공 기준
- ✅ **기술적 성공**: 시스템이 안정적으로 자동 실행
- ✅ **학습 성공**: AI가 실제로 실패에서 배워 개선
- ✅ **운영 성공**: 지속적으로 수익성 있는 거래 실행

**최종 목표**: 인간의 개입 없이 스스로 학습하고 진화하는 완전 자율 트레이딩 시스템 구축